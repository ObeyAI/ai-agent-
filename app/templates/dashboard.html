<!-- app/templates/dashboard.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dialer Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>body{padding:20px}</style>
</head>
<body>
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1>ðŸ“ž Dialer Dashboard</h1>
      <div>
        <button id="startBtn" class="btn btn-primary">Start Dialer</button>
      </div>
    </div>
    <div id="summary" class="mb-2 text-muted small"></div>
    <table class="table table-sm table-striped">
      <thead>
        <tr><th>Call ID</th><th>To</th><th>From</th><th>Status</th><th>Loop</th><th>Quality</th><th>Recording</th></tr>
      </thead>
      <tbody id="callsBody"></tbody>
    </table>
  </div>

<script>
const socket = io(); // connects to host
socket.on("connect", ()=> console.log("socket connected"));
socket.on("call_update", msg => {
  // msg will be {call_id: {...}} or similar
  console.log("call_update", msg);
  refreshTable(); // fetch full status for simplicity
});

async function fetchStatus(){
  const res = await fetch('/status');
  return res.json();
}
async function refreshTable(){
  const data = await fetchStatus();
  const tbody = document.getElementById('callsBody');
  tbody.innerHTML = '';
  let total=0, hot=0;
  Object.entries(data).forEach(([cid, info])=>{
    total++;
    if(info.quality==='HOT') hot++;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><code>${cid}</code></td>
      <td>${info.to||'-'}</td>
      <td>${info.from||'-'}</td>
      <td>${info.status||'-'}</td>
      <td>${info.loop||0}</td>
      <td>${info.quality||'COLD'}</td>
      <td>${info.last_recording ? `<a href="${info.last_recording}" target="_blank">play</a>` : '-'}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('summary').innerText = `Calls: ${total} | HOT: ${hot}`;
}
document.getElementById('startBtn').addEventListener('click', async ()=> {
  await fetch('/start', {method:'POST'});
  refreshTable();
});
setInterval(refreshTable, 2000);
refreshTable();
</script>
</body>
</html>
