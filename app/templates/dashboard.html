<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Dialer Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { padding: 20px; }
    .call-row.hot { background: #ffe8e6; }
    .small-muted { font-size: .85rem; color:#666; }
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1>ðŸ“ž Dialer Dashboard</h1>
      <div>
        <button class="btn btn-primary" onclick="startDialer()">Start Dialer</button>
        <button class="btn btn-secondary" onclick="refresh()">Refresh</button>
      </div>
    </div>

    <div class="mb-3 small-muted">Auto-refresh every 2s. This UI shows live call status, recordings, quality.</div>

    <div id="summary" class="mb-3"></div>

    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>Call ID</th>
          <th>To</th>
          <th>From</th>
          <th>Status</th>
          <th>Loop</th>
          <th>Quality</th>
          <th>Recording</th>
        </tr>
      </thead>
      <tbody id="calls-tbody"></tbody>
    </table>
  </div>

<script>
async function fetchStatus() {
  const res = await fetch('/status');
  return res.json();
}
function render(data) {
  const tbody = document.getElementById('calls-tbody');
  tbody.innerHTML = '';
  let total = 0, hot = 0;
  Object.entries(data).forEach(([cid, info])=>{
    total++;
    if (info.quality === 'HOT') hot++;
    const tr = document.createElement('tr');
    tr.className = (info.quality==='HOT') ? 'call-row hot' : '';
    tr.innerHTML = `
      <td><code>${cid}</code></td>
      <td>${info.to || '-'}</td>
      <td>${info.from || '-'}</td>
      <td>${info.status || '-'}</td>
      <td>${info.loop || 0}</td>
      <td>${info.quality || 'COLD'}</td>
      <td>${info.last_recording ? '<a href="'+info.last_recording+'" target="_blank">play</a>' : '-'}</td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById('summary').innerText = 'Calls: ' + total + ' | HOT: ' + hot;
}

async function refresh(){
  const data = await fetchStatus();
  render(data);
}

async function startDialer(){
  await fetch('/start', {method:'POST'});
  // immediate refresh
  setTimeout(refresh, 300);
}

setInterval(refresh, 2000);
refresh();
</script>
</body>
</html>
